<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>GlobalRadio.top ‚Äî Global online radio directory</title>
  <meta name="description" content="GlobalRadio.top: a global directory of online radios. Filter by country, style, popularity, save favorites, and listen live with a stable player + best-effort live metadata." />
  <meta name="robots" content="index, follow, max-image-preview:large" />
  <meta name="theme-color" content="#0b1227" />
  <link rel="canonical" href="https://globalradio.top/" />

  <meta property="og:type" content="website" />
  <meta property="og:title" content="GlobalRadio.top ‚Äî Global online radio directory" />
  <meta property="og:description" content="Explore radios worldwide: countries, styles, favorites, stable playback and best-effort live metadata." />
  <meta property="og:url" content="https://globalradio.top/" />
  <meta property="og:image" content="https://globalradio.top/assets/globalradio-logo.jpg" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="GlobalRadio.top ‚Äî Global online radio directory" />
  <meta name="twitter:description" content="Explore radios worldwide: countries, styles, favorites, stable playback and best-effort live metadata." />
  <meta name="twitter:image" content="https://globalradio.top/assets/globalradio-logo.jpg" />

  <link rel="preconnect" href="https://de1.api.radio-browser.info" crossorigin />
  <link rel="dns-prefetch" href="https://de1.api.radio-browser.info" />

  <!-- Dynamic favicon (updated by visualizer) -->
  <link id="favicon" rel="icon" type="image/png" href="assets/favicon.png" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "GlobalRadio.top",
    "url": "https://globalradio.top/",
    "potentialAction": {
      "@type": "SearchAction",
      "@id": "https://globalradio.top/#search",
      "target": "https://globalradio.top/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <style>
    :root{
      --bg0:#060914;
      --bg1:#0b1227;
      --text:#e7eefc;
      --muted:#a9b7d6;
      --accent:#4da3ff;
      --accent2:#7c5cff;
      --live:#ff4d6d;
      --warn:#f59e0b;
      --ok:#22c55e;
      --cyan:#22d3ee;
      --shadow: 0 18px 55px rgba(0,0,0,.40);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);
      --r20: 20px;
      --max: 1200px;
      --bottom-safe: 260px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,92,255,.20), transparent 60%),
        radial-gradient(1000px 600px at 85% 20%, rgba(77,163,255,.18), transparent 55%),
        radial-gradient(900px 500px at 50% 95%, rgba(255,77,109,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x: hidden;
    }

    #bottomSpacer{ width:100%; height: var(--bottom-safe); }

    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      opacity:.10;
      mix-blend-mode: overlay;
      z-index:0;
    }

    header{
      position:relative;
      z-index:1;
      padding: 28px 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      background: linear-gradient(135deg, rgba(77,163,255,.18), rgba(124,92,255,.14));
      backdrop-filter: blur(10px);
    }

    .wrap{ max-width: var(--max); margin:0 auto; }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .brand h1{ margin:0; font-size: 2.2rem; line-height: 1.1; }
    .brand p{ margin:8px 0 0; color: var(--muted); max-width: 760px; }

    .siteLogo{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
      flex: 0 0 auto;
    }

    .brandLink{
      display:inline-flex;
      align-items:center;
      gap: 12px;
      text-decoration:none;
      color: var(--text);
      user-select:none;
    }
    .brandLink:hover{ opacity: .92; }

    .filters{
      position:relative;
      z-index:1;
      margin: 16px auto 10px;
      padding: 0 16px;
    }
    .filters .bar{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    select, input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      min-width: 210px;
      flex: 1;
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
      backdrop-filter: blur(12px);
    }
    input::placeholder{ color: rgba(231,238,252,.55); }

    input:focus, select:focus{
      outline: none;
      border-color: var(--accent);
      box-shadow:
        0 0 0 1px rgba(77,163,255,.8),
        0 0 0 4px rgba(77,163,255,.22);
      background-color: rgba(255,255,255,.08);
    }

    select{
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding: 12px 44px 12px 14px;
      cursor: pointer;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23e7eefc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 14px;
    }
    select option{ background-color: #0b1227; color: #e7eefc; }

    .btn{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, background .15s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
      backdrop-filter: blur(12px);
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); }

    .btnSmall{
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .langSwitch{ display:flex; gap:8px; align-items:center; }
    .langSwitch .btnSmall{
      min-width: 52px;
      text-align:center;
      opacity: .65;
    }
    .langSwitch .btnSmall.isActive{
      opacity: 1;
      border-color: rgba(77,163,255,.65);
      box-shadow: 0 0 0 1px rgba(77,163,255,.55), 0 10px 25px rgba(0,0,0,.12);
    }

    .btnCheck{
      display:inline-flex;
      align-items:center;
      gap:10px;
      line-height: 1;
      padding: 12px 14px;
    }
    .btnCheck input{
      width: 18px;
      height: 18px;
      min-width: 18px;
      flex: 0 0 auto;
      margin: 0;
      padding: 0;
      border: 0;
      box-shadow: none;
      background: transparent;
      accent-color: var(--accent);
    }

    .featured{
      position:relative;
      z-index:1;
      margin: 12px auto 16px;
      padding: 0 16px;
    }
    .featured-card{
      max-width: var(--max);
      margin:0 auto;
      display:flex;
      gap: 18px;
      align-items:center;
      padding: 16px 16px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(77,163,255,.18), rgba(124,92,255,.12));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      cursor:pointer;
      transition: transform .25s ease, filter .25s ease;
      backdrop-filter: blur(14px);
    }
    .featured-card:hover{ transform: translateY(-3px); filter: brightness(1.02); }
    .featured-logo{
      width: 92px; height: 92px; border-radius: 50%;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.16);
      display:grid; place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .featured-logo img{ width: 82px; height: 82px; object-fit: contain; }
    .featured-info .title{ margin:0; }
    .featured-info .sub{ margin:6px 0 0; color: rgba(231,238,252,.86); }

    .grid{
      position:relative;
      z-index:1;
      max-width: var(--max);
      margin: 0 auto;
      padding: 0 16px 18px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 14px;
    }

    .station{
      position:relative;
      border-radius: var(--r20);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      overflow:hidden;
      cursor:pointer;
      min-height: 324px;
      backdrop-filter: blur(12px);
      transition: border-color .20s ease;
      transform: translateZ(0);

      opacity: 0;
      transform: translateY(22px) scale(.98);
      filter: blur(6px);
      transition:
        opacity .70s ease,
        transform .70s cubic-bezier(.2,.9,.2,1),
        filter .70s ease,
        border-color .20s ease;
      will-change: transform, opacity, filter;
    }
    .station.isIn{
      opacity: 1;
      transform: translateY(0) scale(1);
      filter: blur(0);
    }

    @media (prefers-reduced-motion: reduce){
      .station{ transition:none !important; opacity:1 !important; transform:none !important; filter:none !important; }
    }

    .stationInner{
      height:100%;
      transition: transform .22s ease;
      will-change: transform;
      transform: translate3d(0,0,0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }
    .station::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease;
      box-shadow: 0 22px 52px rgba(0,0,0,.46);
    }
    .station::before{
      content:"";
      position:absolute;
      inset:-45%;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .22s ease, transform .52s ease;
      background: linear-gradient(120deg, transparent 46%, rgba(255,255,255,.075), transparent 54%);
      transform: translateX(-28%);
    }
    .station:hover{ border-color: rgba(255,255,255,.16); }
    .station:hover .stationInner{ transform: translate3d(0,-3px,0); }
    .station:hover::after{ opacity:1; }
    .station:hover::before{ opacity:1; transform: translateX(30%); }

    .cover{
      height: 170px;
      background:
        radial-gradient(400px 200px at 20% 20%, rgba(77,163,255,.25), transparent 60%),
        radial-gradient(420px 210px at 85% 30%, rgba(124,92,255,.22), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      display:grid;
      place-items:center;
      padding: 14px;
    }
    .logo{
      width: 110px; height: 110px;
      border-radius: 26px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo img{ width: 92px; height: 92px; object-fit: contain; display:block; }

    .meta{ padding: 12px 12px 14px; }
    .name{
      font-weight: 700;
      font-size: 1.02rem;
      line-height: 1.25;
      margin: 0 0 8px;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .chips{ display:flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip{
      font-size:.82rem;
      color: rgba(231,238,252,.92);
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      max-width: 100%;
    }
    .chip .dot{ width:8px; height:8px; border-radius:50%; background: rgba(77,163,255,.9); }
    .chip.muted{ color: rgba(231,238,252,.75); }

    .chip.hs{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
    }
    .chip.hs .dot{
      background:#ef4444;
      box-shadow: 0 0 0 5px rgba(239,68,68,.10);
    }

    .heart{
      position:absolute;
      top: 12px; right: 12px;
      width: 42px; height: 42px;
      border-radius: 999px;
      display:grid; place-items:center;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      cursor:pointer;
      user-select:none;
      z-index: 6;
      transition: transform .15s ease, background .15s ease;
      font-size: 20px;
    }
    .heart:hover{ transform: scale(1.06); background: rgba(0,0,0,.28); }
    .heart.filled{ color: #ff4d6d; }

    .loading{
      padding: 18px 16px;
      border-radius: var(--r20);
      border: 1px dashed rgba(255,255,255,.14);
      color: var(--muted);
      text-align:center;
      background: rgba(255,255,255,.03);
      width: 100%;
      max-width: var(--max);
      margin: 0 auto;
    }

    #detailView{
      display:none;
      position:relative;
      z-index:1;
      padding: 18px 16px 18px;
      min-height: calc(100vh - 260px);
    }
    .detail-card{
      max-width: 860px;
      margin: 0 auto;
      padding: 18px;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }
    .detail-top{ display:flex; gap: 16px; align-items:center; flex-wrap: wrap; }
    .detail-logo{
      width: 128px; height: 128px;
      border-radius: 30px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.16);
      display:grid; place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .detail-logo img{ width: 96px; height: 96px; object-fit: contain; display:block; }

    .detail-title{ flex:1; min-width: 240px; }
    .detail-title h2{ margin:0; font-size: 1.7rem; line-height:1.15; }
    .detail-title p{ margin:10px 0 0; color: var(--muted); }
    .detail-actions{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; align-items:center; }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(77,163,255,.95), rgba(124,92,255,.90));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 45px rgba(77,163,255,.15);
    }
    #detailTitle{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(231,238,252,.95);
      min-height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .detailHome{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      flex-wrap: wrap;
    }
    .detailHome a{
      color: rgba(231,238,252,.95);
      font-weight: 800;
      text-decoration: none;
      border-bottom: 1px dashed rgba(231,238,252,.35);
      padding-bottom: 2px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .detailHome a:hover{
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .detailHome .hint{
      color: rgba(169,183,214,.92);
      font-size: .92rem;
    }

    .player{
      position:fixed;
      left: 10px; right: 10px;
      bottom: 46px;
      z-index: 110;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(8,10,22,.72);
      backdrop-filter: blur(16px);
      box-shadow: 0 25px 70px rgba(0,0,0,.45);
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items:center;
      flex-wrap: wrap;
    }
    .player.isEmpty{ opacity: .88; }

    .pLogo{
      width: 54px; height: 54px;
      border-radius: 16px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.16);
      display:grid; place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .pLogo img{ width: 44px; height: 44px; object-fit: contain; }

    .pInfo{
      flex: 1 1 320px;
      min-width: 0;
      max-width: 100%;
    }
    .pName, .pTitle, .pStatus{
      display:block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .pName{ font-weight: 800; }
    .pTitle{ color: rgba(231,238,252,.90); font-style: italic; margin-top: 2px; }
    .pStatus{ color: rgba(169,183,214,.92); font-size: .92rem; margin-top: 3px; }

    .pControls{ display:flex; align-items:center; gap: 10px; }
    .playBtn{
      width: 58px; height: 58px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(77,163,255,.95), rgba(124,92,255,.88));
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
      font-size: 26px;
      transition: transform .12s ease, filter .12s ease;
      box-shadow: 0 18px 45px rgba(77,163,255,.14);
    }
    .playBtn:hover{ transform: translateY(-1px); filter: brightness(1.04); }

    .miniBtn{
      width: 44px; height: 44px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease;
    }
    .miniBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.085); }

    .vol{
      display:flex; align-items:center; gap: 8px;
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }

    #volume{
      flex: 0 0 160px;
      min-width: 140px;
      height: 6px;
      padding: 0 !important;
      margin: 0;
      border: 0 !important;
      box-shadow: none !important;
      background: rgba(231,238,252,.22);
      border-radius: 999px;
      cursor: pointer;
      touch-action: pan-x;
      -webkit-appearance: none;
      appearance: none;
    }
    #volume::-webkit-slider-thumb{
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(231,238,252,.92);
      border: 1px solid rgba(255,255,255,.20);
    }
    #volume::-moz-range-thumb{
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(231,238,252,.92);
      border: 1px solid rgba(255,255,255,.20);
    }

    .viz{
      width: 100%;
      flex: 1 1 420px;
      min-width: 280px;
      height: 54px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      position: relative;
    }
    .viz canvas{ width: 100%; height: 100%; display:block; }

    .toast{
      position:fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 200;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(8,10,22,.75);
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow2);
      color: var(--text);
      display:none;
      max-width: min(740px, calc(100vw - 24px));
    }
    .toast.show{ display:block; }

    #fixedFooter{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: 42px;
      z-index: 105;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 12px;
      padding: 0 12px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(8,10,22,.78);
      backdrop-filter: blur(14px);
      color: rgba(169,183,214,.95);
      font-size: .92rem;
      user-select:none;
      flex-wrap: wrap;
    }
    #fixedFooter a{
      color: rgba(231,238,252,.92);
      text-decoration: none;
      font-weight: 800;
      opacity: .95;
    }
    #fixedFooter a:hover{
      opacity: 1;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .footerStatus{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(231,238,252,.95);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .footerStatus .sDot{
      width: 9px; height: 9px; border-radius: 50%;
      background: rgba(169,183,214,.9);
      box-shadow: 0 0 0 5px rgba(169,183,214,.10);
    }
    .footerStatus[data-state="LIVE"] .sDot{ background: var(--live); box-shadow: 0 0 0 6px rgba(255,77,109,.14); animation: pulse 1.1s infinite ease-in-out; }
    .footerStatus[data-state="MUTE"] .sDot{ background: var(--warn); box-shadow: 0 0 0 6px rgba(245,158,11,.12); }
    .footerStatus[data-state="BUFFER"] .sDot{ background: var(--cyan); box-shadow: 0 0 0 6px rgba(34,211,238,.12); animation: pulse 1.0s infinite ease-in-out; }
    .footerStatus[data-state="CONNECT"] .sDot{ background: var(--ok); box-shadow: 0 0 0 6px rgba(34,197,94,.12); }
    .footerStatus[data-state="ERR"] .sDot{ background: #ef4444; box-shadow: 0 0 0 6px rgba(239,68,68,.12); }
    .footerStatus[data-state="PAUSE"] .sDot{ background: rgba(231,238,252,.75); box-shadow: 0 0 0 6px rgba(231,238,252,.10); }
    .footerStatus[data-state="STOP"] .sDot{ background: rgba(148,163,184,.9); box-shadow: 0 0 0 6px rgba(148,163,184,.10); }

    @keyframes pulse{
      0%{ transform: scale(1); opacity: 1; }
      50%{ transform: scale(1.18); opacity: .85; }
      100%{ transform: scale(1); opacity: 1; }
    }

    .madeIn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space: nowrap;
      color: rgba(231,238,252,.92);
      font-weight: 700;
    }
    .frFlag{
      width: 22px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 6px 16px rgba(0,0,0,.22);
      background:
        linear-gradient(90deg,
          #0055A4 0 33.33%,
          #FFFFFF 33.33% 66.66%,
          #EF4135 66.66% 100%);
      display:inline-block;
    }
    .heartBlue{ transform: translateY(0.5px); }

    #scrollTopBtn{
      position: fixed;
      right: 18px;
      bottom: 198px;
      z-index: 140;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(8,10,22,.75);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: none;
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      transition: transform .12s ease;
    }
    #scrollTopBtn:hover{ transform: translateY(-2px); }

    #fsMode{
      position: fixed;
      inset: 0;
      z-index: 999;
      display: none;
      overflow: hidden;
      background:
        radial-gradient(1200px 800px at 50% 30%, rgba(77,163,255,.18), transparent 55%),
        radial-gradient(900px 600px at 60% 70%, rgba(255,77,109,.12), transparent 55%),
        linear-gradient(180deg, rgba(5,7,16,.94), rgba(10,16,36,.92));
      backdrop-filter: blur(14px);
    }
    #fsMode.show{ display:block; }

    .aurora{
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(900px 500px at 20% 30%, rgba(124,92,255,.20), transparent 60%),
        radial-gradient(800px 420px at 80% 40%, rgba(77,163,255,.18), transparent 55%),
        radial-gradient(900px 500px at 60% 80%, rgba(255,77,109,.16), transparent 55%);
      filter: blur(30px);
      opacity: .85;
      transform: translateZ(0);
      animation: auroraMove 12s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes auroraMove{
      0%{ transform: translate3d(-2%, -2%,0) scale(1.02); }
      100%{ transform: translate3d(2%, 2%,0) scale(1.05); }
    }

    .fsTop{
      position:absolute;
      top: 14px; left: 14px; right: 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      z-index: 5;
      flex-wrap: wrap;
    }
    .fsBtn{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(12px);
      transition: transform .12s ease, background .12s ease;
      white-space: nowrap;
    }
    .fsBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }

    .fsCenter{
      position:absolute;
      inset: 0;
      display:grid;
      place-items:center;
      padding: 86px 22px 170px;
      text-align:center;
      z-index: 4;
    }
    .fsLogoWrap{
      width: min(46vh, 380px);
      height: min(46vh, 380px);
      border-radius: 40px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      box-shadow: 0 40px 120px rgba(0,0,0,.55);
      display:grid;
      place-items:center;
      overflow:hidden;
      transform: translateZ(0);
      will-change: transform, filter;
      position: relative;
    }
    .fsLogoWrap:after{
      content:"";
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at 50% 50%, rgba(255,77,109,.25), transparent 55%);
      opacity: .0;
      filter: blur(12px);
      transition: opacity .25s ease;
      pointer-events:none;
    }
    .fsLogoWrap.active:after{ opacity: 1; }
    .fsLogoWrap img{
      width: 78%;
      height: 78%;
      object-fit: contain;
      display:block;
      filter: drop-shadow(0 12px 30px rgba(0,0,0,.35));
      position: relative;
      z-index: 2;
    }
    .fsText{ margin-top: 16px; color: rgba(231,238,252,.92); }
    .fsName{
      font-weight: 950;
      font-size: clamp(18px, 3.2vw, 30px);
      letter-spacing: .2px;
    }
    .fsTitle{
      margin-top: 8px;
      color: rgba(231,238,252,.82);
      font-style: italic;
      font-size: clamp(14px, 2.2vw, 18px);
      min-height: 1.4em;
    }
    .fsCanvas{
      position:absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 44vh;
      max-height: 380px;
      pointer-events:none;
      opacity: .92;
      z-index: 3;
    }
    .fsCanvas canvas{ width: 100%; height: 100%; display:block; }

    @media (max-width: 860px){
      .player{ bottom: 52px; }
      #scrollTopBtn{ bottom: 210px; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <header>
    <div class="wrap topbar">
      <div class="brand">
        <a href="#" class="brandLink" id="homeLink" title="Home">
          <img class="siteLogo" id="siteLogoHeader" src="assets/globalradio-logo.jpg" alt="GlobalRadio.top logo">
          <h1 data-i18n="siteName">GlobalRadio.top</h1>
        </a>
        <p data-i18n="siteTagline">The global directory of online radios ‚Äî explore, discover, listen live.</p>
      </div>

      <div class="langSwitch" aria-label="Language switch">
        <button class="btn btnSmall" id="langEN" type="button">EN</button>
        <button class="btn btnSmall" id="langFR" type="button">FR</button>
      </div>
    </div>
  </header>

  <div class="filters">
    <div class="bar">
      <select id="viewMode" aria-label="View mode">
        <option value="all" data-i18n="viewAll">All stations</option>
        <option value="favorites" data-i18n="viewFavs">Favorites</option>
      </select>

      <select id="sortMode">
        <option value="votes" data-i18n="sortVotes">By popularity</option>
        <option value="clickcount" data-i18n="sortClick">By listeners</option>
        <option value="name" data-i18n="sortName">By name</option>
      </select>

      <input type="text" id="searchInput" data-i18n-placeholder="searchPh" placeholder="Search by name‚Ä¶" />
      <select id="countrySelect"><option value="" data-i18n="allCountries">All countries</option></select>

      <select id="genreSelect">
        <option value="" data-i18n="allStyles">All styles</option>
      </select>

      <label class="btn btnCheck">
        <input id="showBroken" type="checkbox">
        <span data-i18n="showBroken">Show broken stations</span>
      </label>

      <button class="btn" id="clearBtn" data-i18n="reset">Reset</button>
    </div>
  </div>

  <div class="featured">
    <div class="featured-card" id="featuredCard">
      <div class="featured-logo">
        <img src="https://radioabf.com/uploads/695e69373b3b6/site/1767800015_b497cc5aceae9307cbab.png" alt="Radio ABF Logo">
      </div>
      <div class="featured-info">
        <p class="title"><strong>Radio ABF</strong> ‚Äî Alternative Bass Fr√©quence</p>
        <p class="sub" data-i18n="featuredLine">France ‚Ä¢ Techno, House, Electronic, Club ‚Ä¢ 320 kbps</p>
      </div>
    </div>
  </div>

  <div class="grid" id="stationsGrid">
    <div class="loading" data-i18n="loadingStations">Loading stations‚Ä¶</div>
  </div>

  <div class="wrap" style="padding:0 16px; margin-bottom: 40px;">
    <button id="loadMoreBtn" class="btn" style="width:100%; margin:14px 0; display:none;" data-i18n="loadMore">
      Load more
    </button>
    <div id="endMessage" class="loading" style="display:none; margin-bottom: 14px;" data-i18n="endResults">
      End of results.
    </div>
  </div>

  <div id="detailView">
    <div class="detail-card">
      <button class="btn" id="backBtn" data-i18n="back">‚Üê Back</button>
      <div id="detailContent" style="margin-top: 12px;"></div>
    </div>
  </div>

  <div id="bottomSpacer" aria-hidden="true"></div>

  <div class="player isEmpty" id="player">
    <div class="pLogo"><img id="playerLogo" src="assets/globalradio-logo.jpg" alt="Logo"></div>

    <div class="pInfo">
      <div class="pName" id="playerName" data-i18n="chooseRadio">Choose a radio</div>
      <div class="pTitle" id="currentTitle" data-i18n="titleNotAvailable">Title not available</div>
      <div class="pStatus" id="playerStatus" data-i18n="statusSelect">Select a station then ‚ñ∂</div>
    </div>

    <div class="pControls">
      <div class="miniBtn" id="stopBtn" data-i18n-title="ttStop" title="Stop">‚èπ</div>
      <div class="playBtn" id="playPauseBtn" data-i18n-title="ttPlayPause" title="Play / Pause">‚ñ∂</div>
      <div class="miniBtn" id="retryBtn" data-i18n-title="ttRetry" title="Reconnect">‚Üª</div>
      <div class="miniBtn" id="muteBtn" data-i18n-title="ttMute" title="Mute / Unmute">üîä</div>
      <div class="miniBtn" id="fsBtn" data-i18n-title="ttFullscreen" title="Fullscreen">‚õ∂</div>
    </div>

    <div class="vol" data-i18n-title="ttVolume" title="Volume">
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.9" />
    </div>

    <div class="viz" title="Bars + waveform">
      <canvas id="viz"></canvas>
    </div>

    <audio id="audioPlayer" preload="none" crossorigin="anonymous"></audio>
  </div>

  <button id="scrollTopBtn" data-i18n-title="ttScrollTop" title="Scroll to top">‚¨Ü</button>

  <div id="fixedFooter">
    <a href="https://globalradio.top">¬© <span id="year"></span> GlobalRadio.top</a>
    <span style="opacity:.55;">‚Ä¢</span>
    <span id="footerStatus" class="footerStatus" data-state="STOP">
      <span class="sDot"></span><span class="sText">STOP</span>
    </span>
    <span style="opacity:.55;">‚Ä¢</span>
    <span class="madeIn">
      <span data-i18n="madeInFrance">Made in France</span>
      <span class="frFlag" aria-hidden="true"></span>
      <span data-i18n="with">with</span> <span class="heartBlue" aria-hidden="true">ü©µ</span>
    </span>
  </div>

  <div id="fsMode" aria-hidden="true">
    <div class="aurora"></div>

    <div class="fsTop">
      <button class="fsBtn" id="fsClose" type="button" data-i18n="fsClose">‚úï Close</button>
      <div style="display:flex; gap:10px;">
        <button class="fsBtn" id="fsMiniPlay" type="button" data-i18n="fsPlay">‚èØ Play</button>
        <button class="fsBtn" id="fsMiniMute" type="button" data-i18n="fsMute">üîä Mute</button>
      </div>
    </div>

    <div class="fsCenter">
      <div class="fsLogoWrap" id="fsLogoWrap">
        <img id="fsLogo" src="assets/globalradio-logo.jpg" alt="Station logo">
      </div>
      <div class="fsText">
        <div class="fsName" id="fsName">‚Äî</div>
        <div class="fsTitle" id="fsTitle" data-i18n="titleNotAvailable">Title not available</div>
      </div>
    </div>

    <div class="fsCanvas">
      <canvas id="fsViz"></canvas>
    </div>
  </div>

  <script>
    // -----------------------
    // i18n
    // -----------------------
    const I18N = {
      en: {
        siteName: "GlobalRadio.top",
        siteTagline: "The global directory of online radios ‚Äî explore, discover, listen live.",
        viewAll: "All stations",
        viewFavs: "Favorites",
        sortVotes: "By popularity",
        sortClick: "By listeners",
        sortName: "By name",
        searchPh: "Search by name‚Ä¶",
        allCountries: "All countries",
        allStyles: "All styles",
        showBroken: "Show broken stations",
        reset: "Reset",
        featuredLine: "France ‚Ä¢ Techno, House, Electronic, Club ‚Ä¢ 320 kbps",
        loadingStations: "Loading stations‚Ä¶",
        noResults: "No stations found",
        endResults: "End of results.",
        loadMore: "Load more",
        back: "‚Üê Back",
        playStation: "‚ñ∂ Play",
        fav: "Favorite",
        titleLabel: "Title:",
        titleLoading: "Loading title‚Ä¶",
        titleNotAvailable: "Title not available",
        chooseRadio: "Choose a radio",
        statusSelect: "Select a station then ‚ñ∂",
        statusConnecting: "Connecting‚Ä¶",
        statusLive: "Live",
        statusLiveProxy: "Live (proxy)",
        statusAlt: "Live (alternate stream)",
        statusBuffer: "Buffering‚Ä¶",
        statusPaused: "Paused",
        statusStopped: "Stopped",
        statusFailed: "Unable to play this stream (blacklisted for 7 days).",
        searchAltStream: "Stream down ‚Äî searching an alternate stream‚Ä¶",
        madeInFrance: "Made in France",
        with: "with",
        fsClose: "‚úï Close",
        fsPlay: "‚èØ Play",
        fsMute: "Mute",
        toastWelcome: "Welcome to GlobalRadio.top ‚ú®",
        toastPick: "Pick a station first.",
        toastReset: "Filters reset.",
        stationWebsite: "Station website",
        ttStop: "Stop",
        ttPlayPause: "Play / Pause",
        ttRetry: "Reconnect",
        ttMute: "Mute / Unmute",
        ttFullscreen: "Fullscreen",
        ttVolume: "Volume",
        ttScrollTop: "Scroll to top"
      },
      fr: {
        siteName: "GlobalRadio.top",
        siteTagline: "L'annuaire mondial des webradios ‚Äî explore, d√©couvre, √©coute en direct.",
        viewAll: "Toutes les stations",
        viewFavs: "Mes favoris",
        sortVotes: "Par popularit√©",
        sortClick: "Par √©coutes",
        sortName: "Par nom",
        searchPh: "Rechercher par nom‚Ä¶",
        allCountries: "Tous les pays",
        allStyles: "Tous les styles",
        showBroken: "Afficher radios HS",
        reset: "R√©initialiser",
        featuredLine: "France ‚Ä¢ Techno, House, Electronic, Club ‚Ä¢ 320 kbps",
        loadingStations: "Chargement des stations‚Ä¶",
        noResults: "Aucune station trouv√©e",
        endResults: "Fin des r√©sultats.",
        loadMore: "Afficher la suite",
        back: "‚Üê Retour",
        playStation: "‚ñ∂ Lecture",
        fav: "Favori",
        titleLabel: "Titre :",
        titleLoading: "Chargement du titre‚Ä¶",
        titleNotAvailable: "Titre non disponible",
        chooseRadio: "Choisis une radio",
        statusSelect: "S√©lectionne une station puis ‚ñ∂",
        statusConnecting: "Connexion‚Ä¶",
        statusLive: "En direct",
        statusLiveProxy: "En direct (proxy)",
        statusAlt: "En direct (flux alternatif)",
        statusBuffer: "Buffering‚Ä¶",
        statusPaused: "En pause",
        statusStopped: "Arr√™t√©",
        statusFailed: "Impossible de lire ce flux (blacklist 7j).",
        searchAltStream: "Flux HS ‚Äî recherche d‚Äôun flux alternatif‚Ä¶",
        madeInFrance: "Made in France",
        with: "with",
        fsClose: "‚úï Fermer",
        fsPlay: "‚èØ Lecture",
        fsMute: "Muet",
        toastWelcome: "Bienvenue sur GlobalRadio.top ‚ú®",
        toastPick: "Choisis une station d‚Äôabord.",
        toastReset: "Filtres r√©initialis√©s.",
        stationWebsite: "Site web de la radio",
        ttStop: "Arr√™ter",
        ttPlayPause: "Lecture / Pause",
        ttRetry: "Reconnecter",
        ttMute: "Muet / Son",
        ttFullscreen: "Plein √©cran",
        ttVolume: "Volume",
        ttScrollTop: "Remonter"
      }
    };

    let LANG = "en";
    function t(key){
      return (I18N[LANG] && I18N[LANG][key]) || (I18N.en[key] || key);
    }

    // -----------------------
    // Constants / Settings
    // -----------------------
    const API_BASE = "https://de1.api.radio-browser.info/json";
    const limit = 48;
    const SITE_LOGO = "assets/globalradio-logo.jpg";
    const DEFAULT_COUNTRY = "France";

    const RESOLVE_API = "/api/resolve-stream";

    const INFINITE_SCROLL = true;
    const SCROLL_THRESHOLD_PX = 950;

    const PROXY_CHAIN = [
      (u) => u,
      (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`
    ];

    const BAD_TTL_MS = 7 * 24 * 60 * 60 * 1000;
    const BAD_KEY = "gr_bad_stations_v1";

    const RESOLVED_KEY = "gr_resolved_streams_v1";
    const RESOLVED_TTL_MS = 30 * 24 * 60 * 60 * 1000;

    const LAST_STATION_KEY = "gr_last_station_v1";
    const LAST_TITLE_KEY = "gr_last_title_v1";

    const MAIN_STYLES = [
      { en: "Pop", fr: "Pop", tag: "pop" },
      { en: "Rock", fr: "Rock", tag: "rock" },
      { en: "Hip-Hop / Rap", fr: "Hip-Hop / Rap", tag: "hiphop" },
      { en: "Electronic", fr: "√âlectronique", tag: "electronic" },
      { en: "House", fr: "House", tag: "house" },
      { en: "Techno", fr: "Techno", tag: "techno" },
      { en: "Dance", fr: "Dance", tag: "dance" },
      { en: "Jazz", fr: "Jazz", tag: "jazz" },
      { en: "Classical", fr: "Classique", tag: "classical" },
      { en: "Reggae", fr: "Reggae", tag: "reggae" },
      { en: "Latin", fr: "Latino", tag: "latin" },
      { en: "R&B / Soul", fr: "R&B / Soul", tag: "rnb" },
      { en: "Blues", fr: "Blues", tag: "blues" },
      { en: "Metal", fr: "Metal", tag: "metal" },
      { en: "Country", fr: "Country", tag: "country" },
      { en: "World", fr: "World", tag: "world" },
      { en: "Chill / Lounge", fr: "Chill / Lounge", tag: "chill" },
      { en: "News / Talk", fr: "Actu / Talk", tag: "news" }
    ];

    // -----------------------
    // Helpers
    // -----------------------
    function now(){ return Date.now(); }
    function isExpired(ts, ttl){ return !ts || (now() - ts > ttl); }

    function loadMap(key){
      try { return JSON.parse(localStorage.getItem(key) || "{}"); }
      catch(e){ return {}; }
    }
    function saveMap(key, map){ localStorage.setItem(key, JSON.stringify(map)); }

    let badMap = loadMap(BAD_KEY);
    let resolvedMap = loadMap(RESOLVED_KEY);

    function isBadStationByUrl(url){
      if (!url) return true;
      const rec = badMap[url];
      if (!rec) return false;
      if (isExpired(rec.ts, BAD_TTL_MS)){
        delete badMap[url];
        saveMap(BAD_KEY, badMap);
        return false;
      }
      return true;
    }
    function markBadUrl(url, reason="fail"){
      if (!url) return;
      badMap[url] = { ts: now(), reason };
      saveMap(BAD_KEY, badMap);
    }
    function unmarkBadUrl(url){
      if (!url) return;
      if (badMap[url]){
        delete badMap[url];
        saveMap(BAD_KEY, badMap);
      }
    }

    function getResolved(fromUrl){
      const rec = resolvedMap[fromUrl];
      if (!rec) return null;
      if (isExpired(rec.ts, RESOLVED_TTL_MS)){
        delete resolvedMap[fromUrl];
        saveMap(RESOLVED_KEY, resolvedMap);
        return null;
      }
      return rec.url || null;
    }
    function setResolved(fromUrl, toUrl){
      if (!fromUrl || !toUrl) return;
      resolvedMap[fromUrl] = { ts: now(), url: toUrl };
      saveMap(RESOLVED_KEY, resolvedMap);
    }

    function safeText(v, fallback=""){ return (v && String(v).trim()) ? String(v).trim() : fallback; }

    function normalizeStation(st){
      const stream = st.url_resolved || st.url || st.stream || "";
      return {
        name: safeText(st.name, "Radio"),
        favicon: st.favicon || "",
        url: stream,
        homepage: st.homepage || "",
        country: st.country || "",
        tags: st.tags || "",
        bitrate: st.bitrate || 0,
        codec: st.codec || "",
        uuid: st.uuid || null
      };
    }

    function saveLastStation(st){
      try{
        const s = normalizeStation(st);
        localStorage.setItem(LAST_STATION_KEY, JSON.stringify({ ts: now(), station: s }));
      }catch(e){}
    }
    function loadLastStation(){
      try{
        const raw = localStorage.getItem(LAST_STATION_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.station) return null;
        return normalizeStation(obj.station);
      }catch(e){ return null; }
    }
    function saveLastTitle(title){
      try{ localStorage.setItem(LAST_TITLE_KEY, JSON.stringify({ ts: now(), title: String(title||"") })); }catch(e){}
    }
    function loadLastTitle(){
      try{
        const raw = localStorage.getItem(LAST_TITLE_KEY);
        if (!raw) return "";
        const obj = JSON.parse(raw);
        return (obj && obj.title) ? String(obj.title) : "";
      }catch(e){ return ""; }
    }

    function safeDomainFromStation(st){
      const src = st.homepage || st.url || "";
      try{ return new URL(src).hostname.replace(/^www\./,""); }
      catch(e){ return ""; }
    }
    function guessStationLogoCandidates(st){
      const domain = safeDomainFromStation(st);
      const candidates = [];
      if (st.favicon) candidates.push(st.favicon);
      if (domain){
        candidates.push(`https://www.google.com/s2/favicons?domain=${encodeURIComponent(domain)}&sz=128`);
        candidates.push(`https://icons.duckduckgo.com/ip3/${encodeURIComponent(domain)}.ico`);
      }
      candidates.push(SITE_LOGO);
      return candidates;
    }
    function setImgWithFallbacks(imgEl, urlList){
      let i = 0;
      const tryNext = ()=>{
        if (i >= urlList.length){
          imgEl.src = SITE_LOGO;
          return;
        }
        imgEl.src = urlList[i++];
      };
      imgEl.onerror = tryNext;
      tryNext();
    }

    function normalizeHomepage(hp){
      const s = safeText(hp,"");
      if (!s) return "";
      try{
        const u = new URL(s);
        return u.href;
      }catch(e){
        try{
          const u = new URL("https://" + s.replace(/^\/\//,""));
          return u.href;
        }catch(e2){
          return "";
        }
      }
    }

    // -----------------------
    // UI refs
    // -----------------------
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const endMessage = document.getElementById("endMessage");
    const playerEl = document.getElementById("player");
    const fixedFooterEl = document.getElementById("fixedFooter");
    const bottomSpacerEl = document.getElementById("bottomSpacer");
    const scrollTopBtn = document.getElementById("scrollTopBtn");

    // -----------------------
    // State
    // -----------------------
    let stations = [], offset = 0, hasMore = true, loading = false;
    let favorites = JSON.parse(localStorage.getItem("gr_favorites") || "[]");

    let showBroken = (localStorage.getItem("gr_show_broken") === "1");

    const audio = document.getElementById("audioPlayer");
    let audioCtx = null, analyser = null, sourceNode = null, gainNode = null;
    let vizRaf = null;

    let isPlaying = false;
    let isMuted = false;
    let vizLowEnergy = false;

    let currentTryIndex = 0;
    let currentStation = null;

    let playerStateKey = "statusSelect";
    let playerStateText = "";

    let scrollTicking = false;

    const featuredStation = {
      name: "Radio ABF - Alternative Bass Fr√©quence | The DJs' Frequency",
      favicon: "https://radioabf.com/uploads/695e69373b3b6/site/1767800015_b497cc5aceae9307cbab.png",
      url: "https://play.radioabf.com:2590/stream",
      homepage: "https://radioabf.com",
      country: "France",
      tags: "Techno, House, Electronic, Club",
      bitrate: 320,
      codec: "MP3",
      uuid: null
    };

    // -----------------------
    // i18n apply
    // -----------------------
    function buildMainStyles(){
      const sel = document.getElementById("genreSelect");
      const keep = sel.value || "";
      sel.innerHTML = `<option value="" data-i18n="allStyles">${t("allStyles")}</option>`;
      MAIN_STYLES.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.tag;
        opt.textContent = (LANG === "fr") ? s.fr : s.en;
        sel.appendChild(opt);
      });
      sel.value = keep;
    }

    function applyLang(lang){
      LANG = (lang === "fr") ? "fr" : "en";
      localStorage.setItem("gr_lang", LANG);
      document.documentElement.lang = LANG;

      const keepPlayerText = !!currentStation || (!!audio && !!audio.src);

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const k = el.dataset.i18n;
        if (!k) return;
        if (keepPlayerText && (el.id === "playerName" || el.id === "currentTitle" || el.id === "fsTitle")) return;
        el.textContent = t(k);
      });

      document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        const k = el.dataset.i18nPlaceholder;
        if (k) el.placeholder = t(k);
      });

      document.querySelectorAll("[data-i18n-title]").forEach(el=>{
        const k = el.dataset.i18nTitle;
        if (k) el.title = t(k);
      });

      document.getElementById("langEN")?.classList.toggle("isActive", LANG === "en");
      document.getElementById("langFR")?.classList.toggle("isActive", LANG === "fr");

      buildMainStyles();

      const statusEl = document.getElementById("playerStatus");
      if (statusEl) statusEl.textContent = playerStateText || t(playerStateKey || "statusSelect");
    }

    // -----------------------
    // Toast
    // -----------------------
    function toast(msg, ms = 2400){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(el._t);
      el._t = setTimeout(()=> el.classList.remove("show"), ms);
    }

    // -----------------------
    // Footer status
    // -----------------------
    function setFooterStatus(state){
      const el = document.getElementById("footerStatus");
      el.dataset.state = state;
      el.querySelector(".sText").textContent = state;
    }

    // -----------------------
    // Player status helpers
    // -----------------------
    function updatePlayerStatus(text){
      playerStateText = String(text || "");
      document.getElementById("playerStatus").textContent = playerStateText;
    }
    function setPlayerStatusKey(key, overrideText = ""){
      playerStateKey = key || "statusSelect";
      playerStateText = overrideText ? String(overrideText) : "";
      document.getElementById("playerStatus").textContent = playerStateText || t(playerStateKey);
    }

    function setPlayIcon(){ document.getElementById("playPauseBtn").textContent = isPlaying ? "‚è∏" : "‚ñ∂"; }

    // -----------------------
    // Bottom safe area (fix overlap)
    // -----------------------
    function updateBottomSafe(){
      const footerH = fixedFooterEl.getBoundingClientRect().height;
      const playerRect = playerEl.getBoundingClientRect();
      const playerBottom = parseFloat(getComputedStyle(playerEl).bottom || "0");
      const safe = Math.ceil(playerBottom + playerRect.height + footerH + 24);
      document.documentElement.style.setProperty("--bottom-safe", safe + "px");
      bottomSpacerEl.style.height = safe + "px";
    }
    window.addEventListener("resize", updateBottomSafe);
    new ResizeObserver(updateBottomSafe).observe(playerEl);
    new ResizeObserver(updateBottomSafe).observe(fixedFooterEl);

    // -----------------------
    // Views
    // -----------------------
    function isDetailOpen(){ return document.getElementById("detailView").style.display === "block"; }
    function isHome(){ return !isDetailOpen(); }
    function isFavorites(){ return document.getElementById("viewMode").value === "favorites"; }

    // -----------------------
    // Favorites
    // -----------------------
    function saveFavorites(){ localStorage.setItem("gr_favorites", JSON.stringify(favorites)); }
    function isFavorite(station){
      return favorites.some(f =>
        (f.uuid && station.uuid && f.uuid === station.uuid) ||
        (!f.uuid && !station.uuid && f.name === station.name && f.url === station.url)
      );
    }
    function toggleFavorite(station){
      const s = normalizeStation(station);
      const idx = favorites.findIndex(f =>
        (f.uuid && s.uuid && f.uuid === s.uuid) ||
        (!f.uuid && !s.uuid && f.name === s.name && f.url === s.url)
      );
      if (idx > -1) favorites.splice(idx, 1);
      else favorites.push(s);
      saveFavorites();
      renderStations(false);
      animateGridEntrance();
    }

    // -----------------------
    // Filters
    // -----------------------
    async function loadFilters(){
      try{
        const countries = await fetch(`${API_BASE}/countries`).then(r => r.json());
        countries.sort((a,b)=> (b.stationcount||0)-(a.stationcount||0));
        const cs = document.getElementById("countrySelect");
        cs.innerHTML = `<option value="" data-i18n="allCountries">${t("allCountries")}</option>`;
        countries.forEach(c=>{
          const opt=document.createElement("option");
          opt.value=c.name;
          opt.textContent=`${c.name} (${c.stationcount})`;
          cs.appendChild(opt);
        });

        const hasFrance = countries.some(c => (c.name||"").toLowerCase() === "france");
        if (hasFrance) cs.value = DEFAULT_COUNTRY;
      }catch(e){}
      buildMainStyles();
    }

    // -----------------------
    // Load stations
    // -----------------------
    async function loadStations(append=false){
      if (loading) return;
      if (!hasMore && append) return;
      loading = true;

      const mode = document.getElementById("viewMode").value;
      if (mode === "favorites"){
        stations = favorites.slice();
        hasMore = false;
        renderStations(false);
        animateGridEntrance();
        loadMoreBtn.style.display = "none";
        endMessage.style.display = stations.length ? "none" : "block";
        endMessage.textContent = stations.length ? "" : t("noResults");
        updateBottomSafe();
        loading = false;
        return;
      }

      const name = document.getElementById("searchInput").value.trim();
      const country = document.getElementById("countrySelect").value || DEFAULT_COUNTRY;
      const tag = document.getElementById("genreSelect").value;
      const sortMode = document.getElementById("sortMode").value || "votes";
      const hideBroken = !showBroken;

      const params = new URLSearchParams({
        limit: String(limit),
        offset: String(append ? offset : 0),
        order: sortMode,
        reverse: (sortMode === "name") ? "false" : "true",
        hidebroken: "true"
      });
      if (name) params.append("name", name);
      if (country) params.append("country", country);
      if (tag) params.append("tag", tag);

      let data = [];
      try{ data = await fetch(`${API_BASE}/stations/search?${params}`).then(r => r.json()); }
      catch(e){ data = []; }

      if (!append){ stations = []; offset = 0; hasMore = true; }

      let normalized = (data||[]).map(normalizeStation).filter(s => s.url);
      if (hideBroken) normalized = normalized.filter(s => !isBadStationByUrl(s.url));

      stations = stations.concat(normalized);
      offset += normalized.length;
      hasMore = normalized.length === limit;

      renderStations(append);
      animateGridEntrance();

      loading = false;

      loadMoreBtn.style.display = (hasMore && mode !== "favorites") ? "block" : "none";
      endMessage.style.display = hasMore ? "none" : "block";
      updateBottomSafe();
    }

    function resetAndReload(){
      if (isDetailOpen()) return;
      offset = 0; hasMore = true; stations = [];
      endMessage.style.display = "none";
      document.getElementById("stationsGrid").innerHTML = `<div class="loading">${t("loadingStations")}</div>`;
      loadStations(false);
    }

    function animateGridEntrance(){
      if (window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches){
        document.querySelectorAll(".station").forEach(el => el.classList.add("isIn"));
        return;
      }
      const cards = Array.from(document.querySelectorAll(".station"));
      if (!cards.length) return;

      cards.forEach(el => {
        el.classList.remove("isIn");
        el.style.transitionDelay = "0ms";
      });

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          cards.forEach((el, i) => {
            const delay = Math.min(520, i * 28);
            el.style.transitionDelay = delay + "ms";
            el.classList.add("isIn");
          });
        });
      });
    }

    function renderStations(append=false){
      const grid = document.getElementById("stationsGrid");
      if (!append) grid.innerHTML = "";

      if (!stations.length){
        grid.innerHTML = `<div class="loading">${t("noResults")}</div>`;
        loadMoreBtn.style.display = "none";
        return;
      }

      const frag = document.createDocumentFragment();
      stations.forEach((station)=>{
        const div = document.createElement("div");
        div.className="station";
        div.onclick=(e)=>{ if (e.target.closest(".heart")) return; showDetail(station); };

        const fav = isFavorite(station);
        const heart = document.createElement("div");
        heart.className = "heart" + (fav ? " filled" : "");
        heart.textContent = fav ? "‚ù§Ô∏è" : "‚ô°";
        heart.onclick = (e)=>{ e.stopPropagation(); toggleFavorite(station); };

        const inner = document.createElement("div");
        inner.className = "stationInner";

        const cover = document.createElement("div");
        cover.className="cover";

        const logo = document.createElement("div");
        logo.className="logo";

        const img = document.createElement("img");
        img.loading="lazy";
        img.alt=station.name;
        setImgWithFallbacks(img, guessStationLogoCandidates(station));
        logo.appendChild(img);
        cover.appendChild(logo);

        const meta = document.createElement("div");
        meta.className="meta";

        const hs = isBadStationByUrl(station.url);
        const countryText = safeText(station.country, (LANG === "fr" ? "Monde" : "World"));

        meta.innerHTML = `
          <div class="name">${station.name}</div>
          <div class="chips">
            <span class="chip"><span class="dot"></span>${countryText}</span>
            <span class="chip muted">${safeText(station.codec,(LANG==="fr"?"Flux":"Stream"))}${station.bitrate ? ` ‚Ä¢ ${station.bitrate} kbps` : ""}</span>
            ${hs ? `<span class="chip hs" title="Recently detected as broken (local blacklist)."><span class="dot"></span>HS</span>` : ""}
          </div>
          <div class="chips" style="margin-top:10px;">
            <span class="chip"><span class="dot"></span>${LANG==="fr" ? "√âcouter" : "Listen"}</span>
            <span class="chip muted" title="${safeText(station.tags,"")}" style="max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
              ${safeText(station.tags,(LANG==="fr"?"Divers":"Misc")).slice(0,56)}${station.tags && station.tags.length>56 ? "‚Ä¶" : ""}
            </span>
          </div>
        `;

        inner.appendChild(cover);
        inner.appendChild(meta);

        div.appendChild(heart);
        div.appendChild(inner);
        frag.appendChild(div);
      });
      grid.appendChild(frag);
    }

    // -----------------------
    // Detail view
    // -----------------------
    function showDetail(station){
      currentStation = normalizeStation(station);
      document.getElementById("detailView").style.display = "block";
      document.querySelector(".filters").style.display = "none";
      document.querySelector(".featured").style.display = "none";
      document.getElementById("stationsGrid").style.display = "none";
      loadMoreBtn.style.display = "none";
      endMessage.style.display = "none";
      populateDetail(currentStation);
      window.scrollTo({ top: 0, behavior: "smooth" });
      updateBottomSafe();
    }

    function showList(){
      document.getElementById("detailView").style.display = "none";
      document.querySelector(".filters").style.display = "block";
      document.querySelector(".featured").style.display = "block";
      document.getElementById("stationsGrid").style.display = "grid";
      loadMoreBtn.style.display = (hasMore && document.getElementById("viewMode").value !== "favorites") ? "block" : "none";
      window.scrollTo({ top: 0, behavior: "smooth" });
      updateBottomSafe();
      animateGridEntrance();
    }

    function populateDetail(station){
      const logoCandidates = guessStationLogoCandidates(station);

      const home = normalizeHomepage(station.homepage);
      const host = (()=>{
        try{ return home ? new URL(home).host.replace(/^www\./,"") : ""; }catch(e){ return ""; }
      })();

      const homeBlock = home ? `
        <div class="detailHome">
          <a href="${home}" target="_blank" rel="noopener noreferrer" title="${home}">
            üåê <span>${t("stationWebsite")}</span>: <span style="opacity:.92">${host}</span> ‚Üó
          </a>
        </div>
      ` : `
        <div class="detailHome">
          <span class="hint" style="opacity:.85;">${LANG==="fr" ? "Site web non renseign√©" : "Website not provided"}</span>
        </div>
      `;

      document.getElementById("detailContent").innerHTML = `
        <div class="detail-top">
          <div class="detail-logo">
            <img id="detailLogo" alt="${station.name}">
          </div>

          <div class="detail-title">
            <h2>${station.name}</h2>
            <p>${safeText(station.country, LANG==="fr" ? "Monde" : "World")} ‚Ä¢ ${safeText(station.tags, LANG==="fr" ? "Divers" : "Misc")}</p>
            <p style="margin-top:8px; color: rgba(169,183,214,.95);">
              ${safeText(station.codec, LANG==="fr" ? "Flux" : "Stream")}
              ${station.bitrate ? ` ‚Ä¢ ${station.bitrate} kbps` : ""}
            </p>

            ${homeBlock}

            <div class="detail-actions">
              <button class="btn btnPrimary" id="detailPlay">${t("playStation")}</button>
              <button class="btn" id="detailFav">${isFavorite(station) ? "‚ù§Ô∏è" : "‚ô°"} ${t("fav")}</button>
            </div>
          </div>
        </div>

        <div id="detailTitle">${t("titleLabel")} ${t("titleLoading")}</div>
      `;

      const detailLogo = document.getElementById("detailLogo");
      setImgWithFallbacks(detailLogo, logoCandidates);

      document.getElementById("detailPlay").onclick = ()=> playStation(station, { autoStart: true });
      document.getElementById("detailFav").onclick = ()=>{
        toggleFavorite(station);
        populateDetail(station);
      };

      requestTitleRefresh();
    }

    // -----------------------
    // Title engine (Icecast/Shoutcast/RadioBrowser best effort)
    // -----------------------
    function cleanTitle(tit){
      if (!tit) return "";
      return String(tit).replace(/\s+/g, " ").replace(/[\u0000-\u001f]/g, "").trim();
    }

    function baseFromUrl(u){
      try{ const url = new URL(u); return `${url.protocol}//${url.host}`; }
      catch(e){ return null; }
    }
    async function fetchJson(url, timeoutMs=4500){
      try{
        const ctrl = new AbortController();
        const tt = setTimeout(()=> ctrl.abort(), timeoutMs);
        const r = await fetch(url, { signal: ctrl.signal, redirect: "follow" });
        clearTimeout(tt);
        if (!r.ok) return null;
        return await r.json();
      }catch(e){ return null; }
    }
    async function getTitleFromIcecast(streamUrl){
      const base = baseFromUrl(streamUrl);
      if (!base) return "";
      const data = await fetchJson(`${base}/status-json.xsl`);
      if (!data) return "";
      const ic = data.icestats || data;
      let src = ic.source;
      if (!src) return "";
      const pick = (s)=> cleanTitle(s.title || s.streamtitle || s.server_name || "");
      if (Array.isArray(src)) return pick(src[0]);
      return pick(src);
    }
    async function getTitleFromShoutcast(streamUrl){
      const base = baseFromUrl(streamUrl);
      if (!base) return "";
      const data = await fetchJson(`${base}/stats?sid=1&json=1`);
      if (!data) return "";
      const t0 =
        data?.songtitle ||
        data?.song ||
        data?.streamtitle ||
        data?.servertitle ||
        (data?.streams && data.streams[0] && (data.streams[0].songtitle || data.streams[0].title)) ||
        "";
      return cleanTitle(t0);
    }
    async function getTitleFromRadioBrowser(uuid){
      if (!uuid) return "";
      try{
        const r = await fetch(`${API_BASE}/url/${uuid}`);
        if (!r.ok) return "";
        const data = await r.json();
        return cleanTitle(data?.song || "");
      }catch(e){ return ""; }
    }
    async function bestEffortTitle(station){
      const stream = station?.url || station?.url_resolved || "";
      let tit = await getTitleFromIcecast(stream);
      if (tit) return tit;
      tit = await getTitleFromShoutcast(stream);
      if (tit) return tit;
      tit = await getTitleFromRadioBrowser(station?.uuid);
      if (tit) return tit;
      return "";
    }

    function setTitleUIPlayer(title){
      const msg = cleanTitle(title) || t("titleNotAvailable");
      document.getElementById("currentTitle").textContent = msg;
      document.getElementById("fsTitle").textContent = msg;
      if (cleanTitle(title)) saveLastTitle(cleanTitle(title));
    }
    function setTitleUIDetail(title){
      const el = document.getElementById("detailTitle");
      if (!el) return;
      const msg = cleanTitle(title) || t("titleNotAvailable");
      el.textContent = `${t("titleLabel")} ${msg}`;
    }

    let titleTimer = null;
    let lastTitleForUrl = "";
    let titleBusy = false;

    function stopTitleEngine(){
      if (titleTimer) clearInterval(titleTimer);
      titleTimer = null;
      lastTitleForUrl = "";
      titleBusy = false;
    }

    async function requestTitleRefresh(){
      if (!currentStation) return;
      if (titleBusy) return;
      titleBusy = true;

      const stationSnapshot = currentStation;
      const urlSnapshot = stationSnapshot.url || "";

      try{
        const title = await bestEffortTitle(stationSnapshot);

        if (!currentStation || (currentStation.url || "") !== urlSnapshot) return;

        const clean = cleanTitle(title);
        if (clean && clean !== lastTitleForUrl){
          lastTitleForUrl = clean;
          setTitleUIPlayer(clean);
          if (isDetailOpen()) setTitleUIDetail(clean);
        } else if (!clean){
          const cur = document.getElementById("currentTitle").textContent.trim();
          if (!cur || cur === lastTitleForUrl){
            setTitleUIPlayer("");
            if (isDetailOpen()) setTitleUIDetail("");
          } else {
            if (isDetailOpen()) setTitleUIDetail(cur);
          }
        } else {
          if (isDetailOpen()) setTitleUIDetail(lastTitleForUrl);
        }
      } finally {
        titleBusy = false;
      }
    }

    function startTitleEngine(){
      stopTitleEngine();
      requestTitleRefresh();
      titleTimer = setInterval(requestTitleRefresh, 12000);
    }

    // -----------------------
    // WebAudio graph (stable)
    // -----------------------
    async function ensureAudioGraph(){
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!audioCtx) audioCtx = new AC();

      if (audioCtx.state === "suspended"){
        try { await audioCtx.resume(); } catch(e){}
      }

      if (!sourceNode){
        sourceNode = audioCtx.createMediaElementSource(audio);

        gainNode = audioCtx.createGain();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.82;

        sourceNode.connect(gainNode);
        gainNode.connect(analyser);
        analyser.connect(audioCtx.destination);
      }
    }

    function applyVolume(v){
      const vol = Math.max(0, Math.min(1, v));
      audio.volume = isMuted ? 0 : vol;
    }

    // -----------------------
    // Visualizer: Bars + Waveform V2 + favicon
    // -----------------------
    const vizCanvas = document.getElementById("viz");
    const vizCtx = vizCanvas.getContext("2d");

    const fsCanvas = document.getElementById("fsViz");
    const fsCtx = fsCanvas.getContext("2d");

    const favCanvas = document.createElement("canvas");
    favCanvas.width = 32; favCanvas.height = 32;
    const favCtx = favCanvas.getContext("2d");
    const faviconEl = document.getElementById("favicon");

    function resizeCanvasToCSS(c){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = c.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width * dpr));
      const h = Math.max(1, Math.floor(rect.height * dpr));
      if (c.width !== w || c.height !== h){
        c.width = w; c.height = h;
      }
      return dpr;
    }

    function roundRect(ctx, x, y, w, h, r){
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
    }

    function drawBars(ctx, canvas, data, opts){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      const bars = opts.bars;
      const step = Math.max(1, Math.floor(data.length / bars));
      const gap = opts.gap;
      const bw = (w - gap*(bars-1)) / bars;

      for (let i=0;i<bars;i++){
        let sum = 0;
        for (let j=0;j<step;j++) sum += data[i*step + j];
        const v = sum / step;
        const amp = v / 255;

        const baseH = Math.max(2, amp * h);
        const mul = vizLowEnergy ? 0.18 : 1.0;
        const finalH = Math.max(2, baseH * mul);

        const x = i * (bw + gap);
        const y = h - finalH;

        const g = ctx.createLinearGradient(0, y, 0, h);
        g.addColorStop(0, "rgba(231,238,252,0.95)");
        g.addColorStop(1, "rgba(231,238,252,0.18)");
        ctx.fillStyle = g;

        const r = Math.min(14, Math.max(6, bw/2));
        roundRect(ctx, x, y, bw, finalH, r);
        ctx.fill();
      }
    }

    // Waveform V2: double line + gradient + soft glow + smoothing
    function drawWaveformV2(ctx, canvas, timeData){
      const w = canvas.width, h = canvas.height;
      const mid = h * 0.52;

      // amplitude
      const amp = h * (vizLowEnergy ? 0.12 : 0.30);

      ctx.save();

      // Slight dark wash for contrast (without clearing bars)
      ctx.globalCompositeOperation = "source-over";
      ctx.fillStyle = "rgba(0,0,0,0.08)";
      ctx.fillRect(0, 0, w, h);

      // Wave gradient
      const grad = ctx.createLinearGradient(0, 0, w, 0);
      grad.addColorStop(0.00, "rgba(77,163,255,0.00)");
      grad.addColorStop(0.12, "rgba(77,163,255,0.85)");
      grad.addColorStop(0.50, "rgba(124,92,255,0.90)");
      grad.addColorStop(0.88, "rgba(77,163,255,0.85)");
      grad.addColorStop(1.00, "rgba(77,163,255,0.00)");

      // Glow line
      ctx.globalCompositeOperation = "lighter";
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.shadowColor = "rgba(77,163,255,0.42)";
      ctx.shadowBlur = 12;

      const thickness = Math.max(1.4, h * 0.045);
      ctx.lineWidth = thickness;
      ctx.strokeStyle = grad;

      // Smooth path with downsampling
      const len = timeData.length;
      const step = Math.max(1, Math.floor(len / 240)); // limit points for smoothness

      ctx.beginPath();
      let first = true;
      for (let i=0;i<len;i+=step){
        const x = (i / (len - 1)) * w;
        const v = (timeData[i] - 128) / 128; // -1..1
        const y = mid + v * amp;
        if (first){ ctx.moveTo(x,y); first = false; }
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // Secondary thin line (crisper highlight)
      ctx.shadowBlur = 0;
      ctx.lineWidth = Math.max(1.0, h * 0.018);
      ctx.strokeStyle = "rgba(231,238,252,0.70)";
      ctx.stroke();

      // Mirror subtle waveform under mid (gives ‚Äúclub‚Äù feel)
      ctx.globalAlpha = vizLowEnergy ? 0.20 : 0.32;
      ctx.lineWidth = Math.max(1.0, h * 0.022);
      ctx.strokeStyle = "rgba(77,163,255,0.38)";
      ctx.beginPath();
      first = true;
      for (let i=0;i<len;i+=step){
        const x = (i / (len - 1)) * w;
        const v = (timeData[i] - 128) / 128;
        const y = mid - v * amp * 0.78; // mirror inverted
        if (first){ ctx.moveTo(x,y); first = false; }
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      ctx.restore();
    }

    function updateDynamicFavicon(level01){
      favCtx.clearRect(0,0,32,32);
      favCtx.fillStyle = "rgba(11,18,39,1)";
      favCtx.fillRect(0,0,32,32);

      const bars = 6, gap = 2;
      const bw = Math.floor((32 - gap*(bars+1)) / bars);

      for (let i=0;i<bars;i++){
        const amp = Math.max(0.08, level01) * (0.45 + i*0.09);
        const bh = Math.max(3, Math.min(26, amp * 26));
        const x = gap + i*(bw+gap);
        const y = 30 - bh;

        favCtx.fillStyle = isMuted ? "rgba(245,158,11,0.95)" : "rgba(77,163,255,0.95)";
        favCtx.fillRect(x, y, bw, bh);
      }

      try{ faviconEl.href = favCanvas.toDataURL("image/png"); }catch(e){}
    }

    function startVizLoop(){
      if (vizRaf) return;

      const freq = new Uint8Array(1024);
      const time = new Uint8Array(2048);

      const loop = ()=>{
        vizRaf = requestAnimationFrame(loop);
        if (!analyser) return;

        resizeCanvasToCSS(vizCanvas);
        resizeCanvasToCSS(fsCanvas);

        analyser.getByteFrequencyData(freq);
        analyser.getByteTimeDomainData(time);

        let sum = 0;
        for (let i=0;i<freq.length;i++) sum += freq[i];
        const level01 = (sum / freq.length) / 255;

        // Player: bars + waveform V2 overlay
        drawBars(vizCtx, vizCanvas, freq, { bars: 26, gap: 6 });
        drawWaveformV2(vizCtx, vizCanvas, time);

        // Fullscreen: bars + waveform V2 overlay (optional but nice)
        drawBars(fsCtx, fsCanvas, freq, { bars: 92, gap: 6 });
        drawWaveformV2(fsCtx, fsCanvas, time);

        if (!loop._t || performance.now() - loop._t > 250){
          loop._t = performance.now();
          updateDynamicFavicon(level01);
        }

        const wrap = document.getElementById("fsLogoWrap");
        if (wrap){
          const boost = vizLowEnergy ? 0.08 : 0.22;
          const s = 1 + level01 * boost;
          wrap.style.transform = `scale(${s.toFixed(3)})`;
          wrap.classList.toggle("active", !vizLowEnergy && level01 > 0.20);
        }
      };
      loop();
    }

    function stopVizLoop(){
      if (vizRaf){
        cancelAnimationFrame(vizRaf);
        vizRaf = null;
      }
    }

    // -----------------------
    // Resolver placeholder (Part 2 later)
    // -----------------------
    async function resolveStreamViaServer(station){
      const cached = getResolved(station.url);
      if (cached) return cached;

      const qs = new URLSearchParams();
      if (station.homepage) qs.set("homepage", station.homepage);
      if (station.url) qs.set("stream", station.url);
      if (station.name) qs.set("name", station.name);

      try{
        const r = await fetch(`${RESOLVE_API}?${qs.toString()}`, { method: "GET" });
        if (!r.ok) return null;
        const data = await r.json();
        if (data && data.url){
          setResolved(station.url, data.url);
          return data.url;
        }
      }catch(e){}
      return null;
    }

    // -----------------------
    // Player
    // -----------------------
    function setPlayerStationUI(station){
      playerEl.classList.remove("isEmpty");
      document.getElementById("playerName").textContent = station.name || "Radio";
      setImgWithFallbacks(document.getElementById("playerLogo"), guessStationLogoCandidates(station));
      setImgWithFallbacks(document.getElementById("fsLogo"), guessStationLogoCandidates(station));
      document.getElementById("fsName").textContent = station.name || "Radio";
      updateBottomSafe();
    }

    function setAudioSourceWithProxy(url, tryIndex){
      const make = PROXY_CHAIN[Math.min(tryIndex, PROXY_CHAIN.length-1)];
      audio.src = make(url);
      audio.load();
    }

    async function tryPlayUrl(url){
      for (let i=0;i<PROXY_CHAIN.length;i++){
        currentTryIndex = i;
        setAudioSourceWithProxy(url, i);
        try{
          await ensureAudioGraph();
          startVizLoop();
          applyVolume(parseFloat(document.getElementById("volume").value || "0.9"));
          await audio.play();
          return true;
        }catch(e){}
      }
      return false;
    }

    async function startPlaybackWithFallbacks(station){
      setPlayerStatusKey("statusConnecting");
      setFooterStatus("CONNECT");

      setTitleUIPlayer("");
      if (isDetailOpen()) setTitleUIDetail("");

      if (await tryPlayUrl(station.url)){
        isPlaying = true; document.getElementById("playPauseBtn").textContent = "‚è∏";
        if (currentTryIndex===0) setPlayerStatusKey("statusLive");
        else updatePlayerStatus(`${t("statusLiveProxy")} ${currentTryIndex}`);
        setFooterStatus(isMuted ? "MUTE" : "LIVE");
        unmarkBadUrl(station.url);
        saveLastStation(station);
        startTitleEngine();
        return true;
      }

      setPlayerStatusKey("searchAltStream");
      setFooterStatus("BUFFER");

      const resolvedUrl = await resolveStreamViaServer(station);
      if (resolvedUrl && resolvedUrl !== station.url){
        if (await tryPlayUrl(resolvedUrl)){
          setResolved(station.url, resolvedUrl);
          unmarkBadUrl(station.url);
          unmarkBadUrl(resolvedUrl);

          station.url = resolvedUrl;
          isPlaying = true; document.getElementById("playPauseBtn").textContent = "‚è∏";
          setPlayerStatusKey("statusAlt");
          setFooterStatus(isMuted ? "MUTE" : "LIVE");
          saveLastStation(station);
          startTitleEngine();
          return true;
        }
      }

      markBadUrl(station.url, "play_failed");
      setPlayerStatusKey("statusFailed");
      setFooterStatus("ERR");
      isPlaying = false; document.getElementById("playPauseBtn").textContent = "‚ñ∂";
      setTitleUIPlayer("");
      if (isDetailOpen()) setTitleUIDetail("");
      return false;
    }

    function playStation(station, { autoStart=false } = {}){
      const s = normalizeStation(station);
      if (!s.url) return toast(t("toastPick"));

      currentStation = s;
      setPlayerStationUI(s);

      // Reset title memory for the new station
      lastTitleForUrl = "";
      setTitleUIPlayer("");
      if (isDetailOpen()) setTitleUIDetail("");

      if (autoStart) startPlaybackWithFallbacks(s);
      else{
        setPlayerStatusKey("statusSelect");
        setFooterStatus("PAUSE");
        isPlaying = false;
        document.getElementById("playPauseBtn").textContent = "‚ñ∂";
      }
    }

    function restoreLastPlayedIntoPlayer(){
      const last = loadLastStation();
      if (!last || !last.url) return;

      currentStation = last;
      setPlayerStationUI(last);

      const lastTitle = loadLastTitle();
      const msg = lastTitle ? lastTitle : t("titleNotAvailable");
      document.getElementById("currentTitle").textContent = msg;
      document.getElementById("fsTitle").textContent = msg;

      isPlaying = false;
      document.getElementById("playPauseBtn").textContent = "‚ñ∂";
      setFooterStatus("PAUSE");
      playerStateKey = "statusPaused";
      playerStateText = (LANG === "fr") ? "Derni√®re station ‚Äî clique ‚ñ∂ pour reprendre" : "Last station ‚Äî press ‚ñ∂ to resume";
      updatePlayerStatus(playerStateText);

      startTitleEngine();
    }

    function stopPlayback(){
      try{ audio.pause(); }catch(e){}
      audio.removeAttribute("src");
      audio.load();

      isPlaying = false;
      document.getElementById("playPauseBtn").textContent = "‚ñ∂";
      setPlayerStatusKey("statusStopped");

      stopTitleEngine();
      stopVizLoop();

      setTitleUIPlayer("");
      if (isDetailOpen()) setTitleUIDetail("");

      currentStation = null;
      playerEl.classList.add("isEmpty");
      document.getElementById("playerName").textContent = t("chooseRadio");
      setFooterStatus("STOP");
      updateBottomSafe();
    }

    function togglePlayPause(){
      if (!currentStation) return toast(t("toastPick"));
      if (isPlaying){ audio.pause(); return; }
      if (!audio.src) startPlaybackWithFallbacks(currentStation);
      else audio.play().catch(()=> startPlaybackWithFallbacks(currentStation));
    }

    // Audio events
    audio.addEventListener("playing", ()=>{
      isPlaying = true;
      document.getElementById("playPauseBtn").textContent = "‚è∏";
      setFooterStatus(isMuted ? "MUTE" : "LIVE");
      if (!playerStateText) setPlayerStatusKey("statusLive");
      startVizLoop();
      startTitleEngine();
    });
    audio.addEventListener("pause", ()=>{
      isPlaying = false;
      document.getElementById("playPauseBtn").textContent = "‚ñ∂";
      if (currentStation){
        setFooterStatus(isMuted ? "MUTE" : "PAUSE");
        setPlayerStatusKey("statusPaused");
      } else {
        setFooterStatus("STOP");
        setPlayerStatusKey("statusStopped");
      }
    });
    audio.addEventListener("waiting", ()=>{
      if (currentStation){
        setFooterStatus(isMuted ? "MUTE" : "BUFFER");
        setPlayerStatusKey("statusBuffer");
      }
    });
    audio.addEventListener("error", ()=>{
      setFooterStatus("ERR");
      setPlayerStatusKey("statusFailed");
    });

    // -----------------------
    // Fullscreen
    // -----------------------
    const fsMode = document.getElementById("fsMode");
    function openFS(){ fsMode.classList.add("show"); document.body.style.overflow = "hidden"; }
    function closeFS(){ fsMode.classList.remove("show"); document.body.style.overflow = ""; }

    document.getElementById("fsBtn").addEventListener("click", openFS);
    document.getElementById("fsClose").addEventListener("click", (e)=>{ e.stopPropagation(); closeFS(); });
    document.getElementById("fsMiniPlay").addEventListener("click", (e)=>{ e.stopPropagation(); togglePlayPause(); });
    document.getElementById("fsMiniMute").addEventListener("click", (e)=>{ e.stopPropagation(); document.getElementById("muteBtn").click(); });
    fsMode.addEventListener("click", (e)=>{ if (e.target === fsMode) closeFS(); });
    window.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && fsMode.classList.contains("show")) closeFS(); });

    // -----------------------
    // Events wiring
    // -----------------------
    document.getElementById("homeLink").addEventListener("click", (e)=>{
      e.preventDefault();
      if (isDetailOpen()) showList();
      else window.scrollTo({ top: 0, behavior: "smooth" });
    });

    document.getElementById("playPauseBtn").addEventListener("click", togglePlayPause);
    document.getElementById("stopBtn").addEventListener("click", stopPlayback);
    document.getElementById("retryBtn").addEventListener("click", ()=>{
      if (!currentStation) return toast(t("toastPick"));
      startPlaybackWithFallbacks(currentStation);
    });

    document.getElementById("muteBtn").addEventListener("click", ()=>{
      isMuted = !isMuted;
      vizLowEnergy = isMuted;
      document.getElementById("muteBtn").textContent = isMuted ? "üîá" : "üîä";
      document.getElementById("fsMiniMute").textContent =
        (isMuted ? "üîá " : "üîä ") + t("fsMute").replace(/^üîä\s*/,"").replace(/^üîá\s*/,"");
      applyVolume(parseFloat(document.getElementById("volume").value || "0.9"));

      if (currentStation) setFooterStatus(isMuted ? "MUTE" : (isPlaying ? "LIVE" : "PAUSE"));
      else setFooterStatus("STOP");
    });

    document.getElementById("volume").addEventListener("input", (e)=>{
      applyVolume(parseFloat(e.target.value || "0.9"));
    });
    applyVolume(parseFloat(document.getElementById("volume").value || "0.9"));

    // Filters
    document.getElementById("viewMode").addEventListener("change", resetAndReload);
    document.getElementById("sortMode").addEventListener("change", resetAndReload);

    let searchTimer=null;
    document.getElementById("searchInput").addEventListener("input", ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=> {
        if (document.getElementById("viewMode").value !== "favorites") resetAndReload();
      }, 250);
    });

    ["countrySelect","genreSelect"].forEach(id=>{
      document.getElementById(id).addEventListener("change", ()=>{
        if (document.getElementById("viewMode").value !== "favorites") resetAndReload();
      });
    });

    // Show broken toggle
    const showBrokenEl = document.getElementById("showBroken");
    showBrokenEl.checked = showBroken;
    showBrokenEl.addEventListener("change", ()=>{
      showBroken = showBrokenEl.checked;
      localStorage.setItem("gr_show_broken", showBroken ? "1" : "0");
      resetAndReload();
    });

    // Clear filters
    document.getElementById("clearBtn").addEventListener("click", ()=>{
      if (isDetailOpen()) showList();
      document.getElementById("viewMode").value = "all";
      document.getElementById("sortMode").value = "votes";
      document.getElementById("searchInput").value = "";
      document.getElementById("countrySelect").value = DEFAULT_COUNTRY;
      document.getElementById("genreSelect").value = "";
      resetAndReload();
      toast(t("toastReset"));
    });

    // Detail nav
    document.getElementById("backBtn").addEventListener("click", showList);

    // Featured
    document.getElementById("featuredCard").addEventListener("click", ()=> showDetail(featuredStation));

    // Load more fallback
    loadMoreBtn.addEventListener("click", ()=> loadStations(true));

    // Scroll-to-top button
    window.addEventListener("scroll", ()=>{
      scrollTopBtn.style.display = window.scrollY > 400 ? "block" : "none";
    }, { passive: true });
    scrollTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));

    // Infinite scroll (home only)
    function handleInfiniteScroll(){
      if (!INFINITE_SCROLL) return;
      if (!isHome()) return;
      if (isFavorites()) return;
      if (loading || !hasMore) return;

      const doc = document.documentElement;
      const scrollBottom = doc.scrollHeight - (window.scrollY + window.innerHeight);
      if (scrollBottom < SCROLL_THRESHOLD_PX){
        loadStations(true);
      }
    }
    window.addEventListener("scroll", ()=>{
      if (!INFINITE_SCROLL) return;
      if (scrollTicking) return;
      scrollTicking = true;
      requestAnimationFrame(()=>{
        scrollTicking = false;
        handleInfiniteScroll();
      });
    }, { passive: true });

    // Language switch (no player reset)
    function refreshDetailLang(){
      if (!currentStation) return;
      populateDetail(currentStation);
      loadMoreBtn.style.display = "none";
      endMessage.style.display = "none";
    }

    document.getElementById("langEN").addEventListener("click", ()=>{
      applyLang("en");
      if (isDetailOpen()) refreshDetailLang();
      else resetAndReload();
    });
    document.getElementById("langFR").addEventListener("click", ()=>{
      applyLang("fr");
      if (isDetailOpen()) refreshDetailLang();
      else resetAndReload();
    });

    // -----------------------
    // Init
    // -----------------------
    document.getElementById("year").textContent = new Date().getFullYear();

    (async function init(){
      const savedLang = localStorage.getItem("gr_lang");
      applyLang(savedLang || "en");

      restoreLastPlayedIntoPlayer();

      await loadFilters();

      offset = 0; hasMore = true;
      document.getElementById("stationsGrid").innerHTML = `<div class="loading">${t("loadingStations")}</div>`;
      loadStations(false);

      updateBottomSafe();
      toast(t("toastWelcome"), 1300);
    })();
  </script>
</body>
</html>
